# Python package
# Create and test a Python package on multiple Python versions.
# Add steps that analyze code, save the dist with the build record, publish to a PyPI-compatible index, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/python

trigger:
- ci_switch

pool:
  vmImage: 'ubuntu-latest'
strategy:
  matrix:
    Python38:
      python.version: '3.8'

steps:
- task: UsePythonVersion@0
  inputs:
    versionSpec: '$(python.version)'
  displayName: 'Use Python $(python.version)'

- bash: echo "##vso[task.prependpath]$CONDA/bin"
  displayName: Add conda to PATH

- bash: conda env create --quiet --file environment.yml
  displayName: Create Anaconda environment and install dependencies

- script: |
    source activate gubbins_env
    python -m pip install --no-deps --ignore-installed .
    source ./install_dependencies.sh
    autoreconf -i && ./configure --enable-maintainer-mode CFLAGS='-O0 --coverage' && make && make check
    pip install codecov
    cd python && coverage run setup.py test
    bash <(curl -s https://codecov.io/bash)
    codecov
  displayName: 'Install, test and check code coverage'
